<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dd.ai_medical_triage.dao.mapper.ChatSessionMapper">

    <!-- 结果集映射：匹配ChatSession实体与chat_session表字段（无需重复指定typeHandler） -->
    <resultMap id="BaseResultMap" type="com.dd.ai_medical_triage.entity.ChatSession">
        <id column="chat_session_id" property="chatSessionId"/>
        <result column="user_id" property="userId"/>
        <result column="summary" property="summary"/>
        <result column="status" property="status"/>
        <result column="create_time" property="createTime"/>
        <result column="update_time" property="updateTime"/>
    </resultMap>

    <!-- 基础字段SQL片段，减少冗余 -->
    <sql id="Base_Column_List">
       chat_session_id, user_id, summary, status, create_time, update_time
    </sql>

    <!-- ==================== SQL 语句 ==================== -->

    <!-- 1. 多条件统计会话总数 -->
    <select id="countByQuery" parameterType="com.dd.ai_medical_triage.dto.chat.ChatSessionQueryDTO" resultType="java.lang.Integer">
        SELECT COUNT(1) FROM `chat_session`
        <where>
            <!-- 条件1：用户名筛选 -->
            <if test="userId != null">
                user_id = #{userId} <!-- 简化：无需显式指定typeHandler -->
            </if>
        </where>
    </select>

    <!-- 2. 多条件查询用户列表（支持标签、筛选、排序、分页） -->
    <select id="selectByQuery" parameterType="com.dd.ai_medical_triage.dto.user.UserQueryDTO" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/> FROM `chat_session`
        <where>
            <!-- 条件1：用户名筛选 -->
            <if test="userId != null">
                user_id = #{userId} <!-- 简化：无需显式指定typeHandler -->
            </if>
        </where>
        <!-- 默认排序 -->
        ORDER BY update_time DESC
        <!-- 分页：基于PageParam的pageNum和pageSize计算偏移量（offset = (pageNum-1)*pageSize） -->
        <if test="pageNum != null and pageSize != null">
            LIMIT #{offset,jdbcType=INTEGER}, #{pageSize,jdbcType=INTEGER}
        </if>
    </select>

</mapper>